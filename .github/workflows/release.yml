name: Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.version.outputs.should_release }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags and changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install toml parser
        run: pip install toml

      - name: Calculate Version from Tags
        id: version
        run: |
          python << 'EOF'
          import toml
          import subprocess
          import os

          # Read eng_ver from pyproject.toml
          with open("pyproject.toml", "r") as f:
              config = toml.load(f)

          eng_ver = config.get("tool", {}).get("budget-analyser", {}).get("eng_ver", 1)
          print(f"EngVer flag: {eng_ver}")

          if eng_ver != 1:
              print("EngVer is 0 (developer mode) - skipping release")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("version=0.0.0\n")
                  f.write("should_release=false\n")
              exit(0)

          # Get latest tag
          try:
              result = subprocess.run(
                  ["git", "describe", "--tags", "--abbrev=0"],
                  capture_output=True, text=True, check=True
              )
              latest_tag = result.stdout.strip()
              print(f"Latest tag: {latest_tag}")
          except subprocess.CalledProcessError:
              latest_tag = "v1.0.0"
              print(f"No tags found, starting from: {latest_tag}")

          # Parse version (remove 'v' prefix)
          version_str = latest_tag.lstrip("v")
          parts = version_str.split(".")
          major = int(parts[0]) if len(parts) > 0 else 1
          minor = int(parts[1]) if len(parts) > 1 else 0
          patch = int(parts[2]) if len(parts) > 2 else 0

          # Increment patch version
          new_patch = patch + 1
          new_version = f"{major}.{minor}.{new_patch}"
          print(f"New version: {new_version}")

          # Set outputs
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={new_version}\n")
              f.write("should_release=true\n")
              f.write(f"prev_tag={latest_tag}\n")
          EOF

      - name: Generate Changelog
        id: changelog
        if: steps.version.outputs.should_release == 'true'
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Generating changelog from $PREV_TAG to HEAD"
          
          if [ -n "$PREV_TAG" ]; then
            # Get commits since last tag
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
            
            # Build changelog
            CHANGELOG="## What's Changed in v$VERSION"$'\n\n'
            
            if [ -n "$COMMITS" ]; then
              CHANGELOG+="$COMMITS"$'\n\n'
            else
              CHANGELOG+="- Minor updates and improvements"$'\n\n'
            fi
            
            CHANGELOG+="**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...v$VERSION"
          else
            CHANGELOG="## Initial Release v$VERSION"$'\n\n'"First release of Budget Analyser!"
          fi
          
          # Save changelog to file for multi-line output
          echo "$CHANGELOG" > changelog.md
          cat changelog.md
          
          # Set output using delimiter for multiline
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create and Push Tag
        if: steps.version.outputs.should_release == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

  build-windows:
    needs: version-and-tag
    if: needs.version-and-tag.outputs.should_release == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update version in pyproject.toml and create VERSION file
        run: |
          $version = "${{ needs.version-and-tag.outputs.version }}"
          $content = Get-Content pyproject.toml -Raw
          $content = $content -replace 'version = ".*"', "version = `"$version`""
          Set-Content pyproject.toml $content
          Write-Host "Updated pyproject.toml to version $version"
          Get-Content pyproject.toml | Select-String "version"
          # Create VERSION file for PyInstaller bundle
          Set-Content -Path "VERSION" -Value $version
          Write-Host "Created VERSION file with: $version"
        shell: pwsh

      - name: Build Windows executable
        run: |
          pyinstaller --name "Budget Analyser" --onefile --windowed --icon=assets/icon.ico --add-data "src/budget_analyser/data;budget_analyser/data" --add-data "VERSION;." src/budget_analyser/__main__.py

      - name: Rename artifact
        run: |
          mv "dist/Budget Analyser.exe" "dist/Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_Windows.exe"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: dist/Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_Windows.exe

  build-macos-intel:
    needs: version-and-tag
    if: needs.version-and-tag.outputs.should_release == 'true'
    runs-on: macos-15-intel  # Intel (x86_64) runner - updated from deprecated macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update version in pyproject.toml and create VERSION file
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          sed -i '' "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          echo "Updated pyproject.toml to version $VERSION"
          grep "version" pyproject.toml
          # Create VERSION file for PyInstaller bundle
          echo "$VERSION" > VERSION
          echo "Created VERSION file with: $VERSION"

      - name: Build macOS Intel app
        run: |
          pyinstaller --name "Budget Analyser" --onefile --windowed --icon=assets/icon.icns --add-data "src/budget_analyser/data:budget_analyser/data" --add-data "VERSION:." src/budget_analyser/__main__.py

      - name: Create ZIP of app
        run: |
          cd dist
          zip -r "Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_Intel.zip" "Budget Analyser.app" || zip -r "Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_Intel.zip" "Budget Analyser"

      - name: Upload macOS Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-build
          path: dist/Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_Intel.zip

  build-macos-arm:
    needs: version-and-tag
    if: needs.version-and-tag.outputs.should_release == 'true'
    runs-on: macos-latest  # Apple Silicon (ARM64) runner
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update version in pyproject.toml and create VERSION file
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          sed -i '' "s/version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          echo "Updated pyproject.toml to version $VERSION"
          grep "version" pyproject.toml
          # Create VERSION file for PyInstaller bundle
          echo "$VERSION" > VERSION
          echo "Created VERSION file with: $VERSION"

      - name: Build macOS ARM app
        run: |
          pyinstaller --name "Budget Analyser" --onefile --windowed --icon=assets/icon.icns --add-data "src/budget_analyser/data:budget_analyser/data" --add-data "VERSION:." src/budget_analyser/__main__.py

      - name: Create ZIP of app
        run: |
          cd dist
          zip -r "Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_AppleSilicon.zip" "Budget Analyser.app" || zip -r "Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_AppleSilicon.zip" "Budget Analyser"

      - name: Upload macOS ARM artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-build
          path: dist/Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_AppleSilicon.zip

  create-release:
    needs: [version-and-tag, build-windows, build-macos-intel, build-macos-arm]
    if: needs.version-and-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts

      - name: Download macOS Intel artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-intel-build
          path: ./artifacts

      - name: Download macOS ARM artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm-build
          path: ./artifacts

      - name: List artifacts
        run: ls -la ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-and-tag.outputs.version }}
          name: Budget Analyser v${{ needs.version-and-tag.outputs.version }}
          body: |
            ${{ needs.version-and-tag.outputs.changelog }}

            ---

            ### Downloads
            - **Windows**: `Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_Windows.exe`
            - **macOS (Intel)**: `Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_Intel.zip`
            - **macOS (Apple Silicon)**: `Budget_Analyser_${{ needs.version-and-tag.outputs.version }}_macOS_AppleSilicon.zip`

            ### Installation
            #### Windows
            1. Download the `.exe` file
            2. Run the executable (you may need to allow it through Windows Defender)

            #### macOS
            1. Download the appropriate `.zip` file for your Mac:
               - **Intel Macs** (pre-2020): Download the `_Intel.zip` version
               - **Apple Silicon Macs** (M1/M2/M3): Download the `_AppleSilicon.zip` version
            2. Extract the `.zip` file
            3. Move `Budget Analyser.app` to your Applications folder
            4. **First launch (Gatekeeper bypass required):**
               - You may see: *"Apple could not verify 'Budget Analyser.app' is free of malware"*
               - **Right-click** (or Control-click) on the app → Select **"Open"** → Click **"Open"** in the dialog
               - This only needs to be done once
            
            **Alternative (Terminal):**
            ```
            xattr -d com.apple.quarantine "/Applications/Budget Analyser.app"
            ```
            
            > **Tip**: To check your Mac type, click  → About This Mac → look for "Chip" (Apple Silicon) or "Processor" (Intel)
            
            > **Why the warning?** The app is not signed with an Apple Developer certificate. It's safe to use - verify by checking the [source code](https://github.com/Harvest-Forged-Code/Analyser).
          files: |
            ./artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
